"""
PvZ AI - Main Controller
With improved strategy and cooldown tracking
"""

import time
import keyboard
import os
import sys
from plant_manager import PlantManager
from strategy import PlantingStrategy
from game_controller import GameController
from config import *

# Optional: YOLO model
try:
    from ultralytics import YOLO
    yolo_available = os.path.exists(YOLO_MODEL_PATH)
    if yolo_available:
        yolo_model = YOLO(YOLO_MODEL_PATH)
        print("‚úÖ YOLO –º–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞")
    else:
        yolo_model = None
        print("‚ö†Ô∏è YOLO –º–æ–¥–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, —Ä–∞–±–æ—Ç–∞ –±–µ–∑ –¥–µ—Ç–µ–∫—Ü–∏–∏ –∑–æ–º–±–∏")
except ImportError:
    yolo_model = None
    yolo_available = False
    print("‚ö†Ô∏è Ultralytics –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, —Ä–∞–±–æ—Ç–∞ –±–µ–∑ –¥–µ—Ç–µ–∫—Ü–∏–∏ –∑–æ–º–±–∏")


class SunTracker:
    """–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ–ª–Ω—Ü"""
    def __init__(self, initial_sun=50):
        self.sun_count = initial_sun
        self.total_collected = 0
        self.total_spent = 0
    
    def add_sun(self, amount=25):
        """–î–æ–±–∞–≤–∏—Ç—å —Å–æ–ª–Ω—Ü–∞ (–ø—Ä–∏ —Å–±–æ—Ä–µ)"""
        self.sun_count += amount
        self.total_collected += amount
    
    def spend_sun(self, amount):
        """–ü–æ—Ç—Ä–∞—Ç–∏—Ç—å —Å–æ–ª–Ω—Ü–∞ (–ø—Ä–∏ –ø–æ—Å–∞–¥–∫–µ)"""
        if self.sun_count >= amount:
            self.sun_count -= amount
            self.total_spent += amount
            return True
        return False
    
    def can_afford(self, cost):
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —Ö–≤–∞—Ç–∞–µ—Ç –ª–∏ —Å–æ–ª–Ω—Ü"""
        return self.sun_count >= cost
    
    def reset(self, initial_sun=50):
        """–°–±—Ä–æ—Å–∏—Ç—å —Å—á—ë—Ç—á–∏–∫"""
        self.sun_count = initial_sun
        self.total_collected = 0
        self.total_spent = 0
    
    def get_stats(self):
        """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"""
        return {
            "current": self.sun_count,
            "collected": self.total_collected,
            "spent": self.total_spent
        }


class PvZAI:
    def __init__(self):
        self.plant_manager = PlantManager()
        self.sun_tracker = SunTracker(initial_sun=50)
        self.strategy = PlantingStrategy(self.plant_manager)
        self.controller = GameController()
        
        self.running = False
        self.setup_complete = False
        self.loop_count = 0
        self.plants_placed = 0
        self.last_sun_check = 0
        
    def setup(self):
        """Initial setup"""
        print("\n" + "="*60)
        print("üåª PvZ AI - –£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è")
        print("="*60)
        
        # Load or create plant configuration
        if self.plant_manager.load_config():
            response = input("\n–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é? (y/n): ").strip().lower()
            if response != 'y':
                self.plant_manager.setup_interactive()
        else:
            print("\n‚ö†Ô∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
            self.plant_manager.setup_interactive()
        
        if not self.plant_manager.plants:
            print("‚ùå –ù–µ—Ç —Ä–∞—Å—Ç–µ–Ω–∏–π –¥–ª—è —Ä–∞–±–æ—Ç—ã!")
            return False
        
        self.setup_complete = True
        return True
    
    def run(self):
        """Main game loop"""
        if not self.setup_complete:
            if not self.setup():
                return
        
        print("\n" + "="*60)
        print("üéÆ –£–ü–†–ê–í–õ–ï–ù–ò–ï")
        print("="*60)
        print("  [Z] - –°—Ç–∞—Ä—Ç/–ü–∞—É–∑–∞")
        print("  [R] - –°–±—Ä–æ—Å —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ (–Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å)")
        print("  [P] - –ü–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç—É —Ä–∞—Å—Ç–µ–Ω–∏–π")
        print("  [S] - –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É")
        print("  [D] - –ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∏")
        print("  [C] - –°–æ–±—Ä–∞—Ç—å —Å–æ–ª–Ω—Ü–∞ –≤—Ä—É—á–Ω—É—é")
        print("  [X] - –í—ã—Ö–æ–¥")
        print("="*60)
        print(f"\n‚òÄÔ∏è –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ–ª–Ω—Ü–µ: {self.sun_tracker.sun_count}")
        print("\n‚è∏Ô∏è  –ù–∞–∂–º–∏ [Z] –¥–ª—è —Å—Ç–∞—Ä—Ç–∞...")
        
        try:
            while True:
                # Handle keyboard input
                if keyboard.is_pressed("z"):
                    self.running = not self.running
                    status = "üü¢ –ê–ö–¢–ò–í–ï–ù" if self.running else "üî¥ –ü–ê–£–ó–ê"
                    print(f"\n{status} | ‚òÄÔ∏è –°–æ–ª–Ω—Ü–µ: {self.sun_tracker.sun_count}")
                    time.sleep(0.5)
                
                if keyboard.is_pressed("r"):
                    self.strategy.reset()
                    self.sun_tracker.reset()
                    self.loop_count = 0
                    self.plants_placed = 0
                    print(f"üîÑ –°–±—Ä–æ—à–µ–Ω–æ | ‚òÄÔ∏è –°–æ–ª–Ω—Ü–µ: {self.sun_tracker.sun_count}")
                    time.sleep(0.5)
                
                if keyboard.is_pressed("p"):
                    self.strategy.print_grid_state()
                    time.sleep(0.5)
                
                if keyboard.is_pressed("s"):
                    self.print_stats()
                    time.sleep(0.5)
                
                if keyboard.is_pressed("d"):
                    self.print_cooldowns()
                    time.sleep(0.5)
                
                if keyboard.is_pressed("c"):
                    if yolo_model:
                        collected = self.controller.collect_collectibles(yolo_model, self.sun_tracker)
                        if collected > 0:
                            print(f"‚òÄÔ∏è –°–æ–±—Ä–∞–Ω–æ –≤—Ä—É—á–Ω—É—é: {collected} | –í—Å–µ–≥–æ: {self.sun_tracker.sun_count}")
                    else:
                        print("‚ö†Ô∏è YOLO –º–æ–¥–µ–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞")
                    time.sleep(0.5)
                
                if keyboard.is_pressed("x"):
                    print("\nüëã –í—ã—Ö–æ–¥...")
                    break
                
                # Main AI loop
                if self.running:
                    self.ai_loop()
                
                time.sleep(0.1)
        
        except KeyboardInterrupt:
            print("\n‚ö†Ô∏è –ü—Ä–µ—Ä–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
        except Exception as e:
            print(f"\n‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
            import traceback
            traceback.print_exc()
        finally:
            self.controller.emergency_stop()
    
    def ai_loop(self):
        """Single iteration of AI logic"""
        try:
            self.loop_count += 1
            
            # Collect suns and coins
            if yolo_model and time.time() - self.last_sun_check > 2.0:
                self.controller.collect_collectibles(yolo_model, self.sun_tracker)
                self.last_sun_check = time.time()
            
            # Detect zombies
            zombies = []
            if yolo_model:
                zombies = self.controller.detect_zombies(yolo_model)
            
            # Get next action from strategy
            action = self.strategy.get_next_action(zombies, self.sun_tracker.sun_count)
            
            if action:
                self.execute_action(action)
            
            # Status update every 10 loops
            if self.loop_count % 10 == 0:
                zombie_rows = sorted(set(r for c, r in zombies))
                zombie_info = f"–†—è–¥—ã: {zombie_rows}" if zombie_rows else "–ù–µ—Ç"
                print(f"üîÑ Loop {self.loop_count} | ‚òÄÔ∏è {self.sun_tracker.sun_count} | üßü {len(zombies)} ({zombie_info}) | üå± {self.plants_placed}")
            
            time.sleep(LOOP_DELAY)
        
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤ —Ü–∏–∫–ª–µ: {e}")
    
    def execute_action(self, action: dict):
        """Execute a planting action"""
        try:
            plant_name = action["plant"]
            col = action["col"]
            row = action["row"]
            reason = action.get("reason", "")
            
            # Get plant data
            plant_data = self.plant_manager.get_plant(plant_name)
            if not plant_data:
                print(f"‚ùå –†–∞—Å—Ç–µ–Ω–∏–µ {plant_name} –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ")
                return
            
            # Get plant cost
            plant_cost = PLANT_COSTS.get(plant_name, 0)
            
            # Check if we can afford it
            if not self.sun_tracker.can_afford(plant_cost):
                return
            
            # Check cooldown
            if not self.strategy.can_plant(plant_name):
                return
            
            # Check if seed is ready
            if not self.controller.check_seed_ready(plant_data["coord"]):
                return
            
            # Plant it
            success = self.controller.plant(
                plant_data["coord"],
                col,
                row
            )
            
            if success:
                # Spend sun
                self.sun_tracker.spend_sun(plant_cost)
                
                # Mark planted with name
                self.strategy.mark_planted(col, row, plant_name)
                self.plants_placed += 1
                
                emoji = self._get_plant_emoji(plant_name)
                print(f"{emoji} {plant_name} ‚Üí ({col},{row}) | {reason} | ‚òÄÔ∏è -{plant_cost} (–æ—Å—Ç–∞–ª–æ—Å—å: {self.sun_tracker.sun_count})")
                
                # Remove plant marker for instant-kill plants
                if plant_name in ["cherry bomb", "jalapeno", "squash", "potato mine"]:
                    time.sleep(3)
                    self.strategy.remove_plant(col, row)
        
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è: {e}")
    
    def _get_plant_emoji(self, plant_name: str) -> str:
        """Get emoji for plant"""
        emojis = {
            "sunflower": "üåª",
            "peashooter": "üî´",
            "snow pea": "‚ùÑÔ∏è",
            "repeater": "üî´üî´",
            "cherry bomb": "üí£",
            "wall-nut": "üõ°Ô∏è",
            "tall-nut": "üõ°Ô∏è",
            "potato mine": "üí•",
            "squash": "üéØ",
            "chomper": "ü¶ñ",
            "spikeweed": "üåµ",
            "jalapeno": "üå∂Ô∏è",
            "torchwood": "üî•",
        }
        return emojis.get(plant_name, "üå±")
    
    def print_cooldowns(self):
        """Print current cooldown status"""
        current_time = time.time()
        elapsed_since_start = current_time - self.strategy.game_start_time
        
        print("\n" + "="*60)
        print("‚è±Ô∏è –ü–ï–†–ï–ó–ê–†–Ø–î–ö–ò –†–ê–°–¢–ï–ù–ò–ô")
        print("="*60)
        
        for plant_name in self.plant_manager.get_all_available():
            initial_cd = PLANT_INITIAL_COOLDOWNS.get(plant_name, 0)
            recharge_cd = PLANT_RECHARGE_COOLDOWNS.get(plant_name, 0)
            
            # Check initial cooldown
            if elapsed_since_start < initial_cd:
                remaining = initial_cd - elapsed_since_start
                print(f"  üî¥ {plant_name:15} | –ù–∞—á–∞–ª—å–Ω–∞—è: {remaining:.1f}s")
                continue
            
            # Check recharge cooldown
            if plant_name in self.strategy.plant_cooldowns:
                last_used = self.strategy.plant_cooldowns[plant_name]
                time_since_use = current_time - last_used
                
                if time_since_use < recharge_cd:
                    remaining = recharge_cd - time_since_use
                    print(f"  üü° {plant_name:15} | –ü–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞: {remaining:.1f}s")
                else:
                    print(f"  üü¢ {plant_name:15} | –ì–û–¢–û–í")
            else:
                print(f"  üü¢ {plant_name:15} | –ì–û–¢–û–í")
        
        print("="*60 + "\n")
    
    def print_stats(self):
        """Print current statistics"""
        sun_stats = self.sun_tracker.get_stats()
        
        print("\n" + "="*60)
        print("üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê")
        print("="*60)
        print(f"  –¶–∏–∫–ª–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: {self.loop_count}")
        print(f"  –†–∞—Å—Ç–µ–Ω–∏–π –ø–æ—Å–∞–∂–µ–Ω–æ: {self.plants_placed}")
        print(f"  –ó–∞–Ω—è—Ç—ã—Ö –∫–ª–µ—Ç–æ–∫: {len(self.strategy.placed_plants)}")
        print(f"  –§–∞–∑–∞: {'–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ —Å–æ–ª–Ω—Ü–∞' if self.strategy.production_phase else '–ó–∞—â–∏—Ç–∞'}")
        print()
        print("‚òÄÔ∏è –°–û–õ–ù–¶–ï:")
        print(f"  –¢–µ–∫—É—â–µ–µ: {sun_stats['current']}")
        print(f"  –°–æ–±—Ä–∞–Ω–æ: {sun_stats['collected']}")
        print(f"  –ü–æ—Ç—Ä–∞—á–µ–Ω–æ: {sun_stats['spent']}")
        print()
        print("üî´ –ì–û–†–û–•–û–°–¢–†–ï–õ–´ –ü–û –†–Ø–î–ê–ú:")
        for row, count in sorted(self.strategy.peashooter_count.items()):
            print(f"  –†—è–¥ {row}: {count} —à—Ç.")
        print("="*60 + "\n")


def main():
    """Entry point"""
    ai = PvZAI()
    ai.run()


if __name__ == "__main__":
    main()
